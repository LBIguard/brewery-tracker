<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brewery Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        beer: {
                            light: '#f8b64c',
                            dark: '#8b4513'
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        .beer-mug-empty {
            filter: opacity(0.4);
        }
        
        .beer-mug-full {
            filter: opacity(1);
        }
        
        .rating-mug {
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .rating-mug:hover {
            transform: scale(1.2);
        }
        
        .rating-mug.selected {
            filter: opacity(1);
        }
        
        .rating-mug.unselected {
            filter: opacity(0.4);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .brewery-popup {
            max-width: 250px;
        }
        
        .brewery-popup h3 {
            margin: 0 0 5px 0;
            color: #8b4513;
        }
        
        .brewery-popup p {
            margin: 5px 0;
        }
        
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            font-size: 14px;
            line-height: 20px;
        }
        
        .legend svg {
            vertical-align: middle;
            margin-right: 5px;
        }
        
        /* Dark mode styles */
        .dark .legend {
            background: #333;
            color: #fff;
        }
        
        .dark .leaflet-popup-content-wrapper {
            background: #333;
            color: #fff;
        }
        
        .dark .leaflet-popup-tip {
            background: #333;
        }
        
        .dark .brewery-popup h3 {
            color: #f8b64c;
        }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #5D5CDE;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .dark .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #5D5CDE;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            background-color: #333;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: #4CAF50;
        }

        .toast.error {
            background-color: #F44336;
        }

        .toast.info {
            background-color: #2196F3;
        }
        
        /* Dropbox notification */
        .dropbox-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 16px;
            border-radius: 6px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            width: 300px;
            border-left: 4px solid #3b82f6;
            transition: transform 0.3s, opacity 0.3s;
            transform: translateY(20px);
            opacity: 0;
        }
        
        .dropbox-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .dark .dropbox-notification {
            background-color: #1f2937;
            color: #e5e7eb;
        }
        
        .auto-update-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #EBF5FF;
            color: #3b82f6;
        }
        
        .dark .auto-update-badge {
            background-color: rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-900 dark:text-white dark:bg-gray-900 flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-beer-light dark:bg-beer-dark text-beer-dark dark:text-beer-light p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Brewery Tracker</h1>
            <div class="flex items-center space-x-2">
                <button id="addBreweryButton" class="px-3 py-1 bg-white dark:bg-gray-800 text-beer-dark dark:text-beer-light rounded shadow hover:bg-gray-100 dark:hover:bg-gray-700 mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add
                </button>
                <button id="statsButton" class="px-3 py-1 bg-white dark:bg-gray-800 text-beer-dark dark:text-beer-light rounded shadow hover:bg-gray-100 dark:hover:bg-gray-700 mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                    </svg>
                    Stats
                </button>
                <div class="dropdown relative">
                    <button id="dropboxButton" class="px-3 py-1 bg-white dark:bg-gray-800 text-beer-dark dark:text-beer-light rounded shadow hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg class="h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L6 7l6 5-6 5 6 5 6-5-6-5 6-5-6-5z"/>
                        </svg>
                        Dropbox
                        <span id="autosyncBadge" class="auto-update-badge hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Auto
                        </span>
                    </button>
                    <div id="dropboxDropdown" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded shadow-lg z-10">
                        <button id="saveToDropbox" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Save to Dropbox
                        </button>
                        <button id="loadFromDropbox" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Load from Dropbox
                        </button>
                        <div class="flex items-center px-4 py-2 border-t border-gray-200 dark:border-gray-700">
                            <input type="checkbox" id="autoLoadDropbox" class="form-checkbox h-4 w-4 text-primary">
                            <label for="autoLoadDropbox" class="ml-2 text-sm">Auto-load on startup</label>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                        <button id="exportData" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Export to File
                        </button>
                        <button id="importData" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                            Import from File
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Filter Bar -->
    <div class="bg-gray-100 dark:bg-gray-800 p-4 shadow-sm">
        <div class="container mx-auto flex flex-wrap gap-3">
            <div class="flex-grow min-w-[200px]">
                <input type="text" id="searchInput" placeholder="Search breweries..." class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 text-base">
            </div>
            <div class="min-w-[150px]">
                <select id="stateFilter" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 text-base">
                    <option value="all">All States</option>
                    <option value="MD">Maryland</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="VA">Virginia</option>
                </select>
            </div>
            <div class="min-w-[150px]">
                <select id="visitedFilter" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 text-base">
                    <option value="all">All Breweries</option>
                    <option value="visited">Visited</option>
                    <option value="notVisited">Not Visited</option>
                </select>
            </div>
            <div class="min-w-[150px]">
                <select id="ratingFilter" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 text-base">
                    <option value="all">All Ratings</option>
                    <option value="5">5+ Mugs</option>
                    <option value="4">4+ Mugs</option>
                    <option value="3">3+ Mugs</option>
                    <option value="2">2+ Mugs</option>
                    <option value="1">1+ Mugs</option>
                    <option value="0">No Rating</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
        <!-- Map Container -->
        <div class="h-1/2 md:h-auto md:w-2/3 relative" id="mapContainer">
            <div id="map"></div>
        </div>
        
        <!-- Sidebar -->
        <div class="h-1/2 md:h-auto md:w-1/3 bg-white dark:bg-gray-800 overflow-auto border-t md:border-t-0 md:border-l border-gray-200 dark:border-gray-700">
            <div class="p-4">
                <h2 class="text-xl font-bold mb-3">Brewery List</h2>
                <div id="breweryList" class="space-y-3">
                    <!-- Breweries will be populated here -->
                    <div class="flex justify-center items-center p-4">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Brewery Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-auto shadow-xl mx-4">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold">Brewery Details</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <p id="modalRank" class="text-gray-600 dark:text-gray-400"></p>
                    <p id="modalLocation" class="text-gray-600 dark:text-gray-400"></p>
                    <p id="modalAddress" class="text-gray-600 dark:text-gray-400 cursor-pointer hover:text-primary"></p>
                </div>
                
                <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">Flagship/Notable Beers:</h4>
                    <p id="modalFlagshipBeer" class="text-gray-600 dark:text-gray-400"></p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Visit Status</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="visitedCheckbox" class="form-checkbox h-5 w-5 text-primary">
                        <label for="visitedCheckbox" class="ml-2">Visited</label>
                    </div>
                    <div id="visitDateContainer" class="mt-2 hidden">
                        <label for="visitDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date Visited</label>
                        <input type="date" id="visitDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Ratings</label>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <span class="w-16">KC:</span>
                            <div class="flex" id="kcRating">
                                <!-- Rating mugs will be added here -->
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="w-16">Jeff:</span>
                            <div class="flex" id="jeffRating">
                                <!-- Rating mugs will be added here -->
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="w-16">Dave:</span>
                            <div class="flex" id="daveRating">
                                <!-- Rating mugs will be added here -->
                            </div>
                        </div>
                        <div class="flex items-center pt-2 border-t border-gray-200 dark:border-gray-700">
                            <span class="w-16 font-bold">Average:</span>
                            <span id="avgRating" class="font-bold">Not rated</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="breweryNotes" class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Notes</label>
                    <textarea id="breweryNotes" rows="4" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base"></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="untappdURL" class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Untappd URL</label>
                    <input type="text" id="untappdURL" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" placeholder="e.g. https://untappd.com/BlackFlagBrewingCompany">
                    <div class="mt-2 flex">
                        <button id="testUntappdLink" class="text-sm text-primary hover:underline">
                            Test URL
                        </button>
                        <span class="mx-2 text-gray-400">|</span>
                        <button id="fixCommonUntappdErrors" class="text-sm text-primary hover:underline">
                            Fix Common Errors
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-3 border-t border-gray-200 dark:border-gray-700">
                    <a id="untappdLink" href="#" target="_blank" class="text-primary hover:underline flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                            <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                        </svg>
                        Open in Untappd
                    </a>
                    <button id="saveBrewery" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full max-h-[90vh] overflow-auto shadow-xl mx-4">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Brewery Statistics</h3>
                <button id="closeStatsModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">Progress</h4>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                        <div id="progressBar" class="bg-primary h-4 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-sm mt-1 text-center">0 of 0 breweries visited (0%)</p>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">Top Rated Breweries</h4>
                    <ul id="topRatedList" class="space-y-2">
                        <li class="text-gray-500 dark:text-gray-400 italic">No rated breweries yet</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">Recent Visits</h4>
                    <ul id="recentVisitsList" class="space-y-2">
                        <li class="text-gray-500 dark:text-gray-400 italic">No visited breweries yet</li>
                    </ul>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Average Rating</p>
                        <p id="avgOverallRating" class="text-xl font-bold">-</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Breweries by State</p>
                        <p id="stateBreakdown" class="text-sm mt-1"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add New Brewery Modal -->
    <div id="addBreweryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-auto shadow-xl mx-4">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Add New Brewery</h3>
                <button id="closeAddBreweryModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="newBreweryName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Brewery Name*</label>
                        <input type="text" id="newBreweryName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" required>
                    </div>
                    <div>
                        <label for="newBreweryRank" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rank</label>
                        <input type="number" id="newBreweryRank" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" min="1">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="newBreweryCity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City*</label>
                        <input type="text" id="newBreweryCity" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" required>
                    </div>
                    <div>
                        <label for="newBreweryState" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">State*</label>
                        <select id="newBreweryState" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" required>
                            <option value="">Select State</option>
                            <option value="MD">Maryland (MD)</option>
                            <option value="PA">Pennsylvania (PA)</option>
                            <option value="VA">Virginia (VA)</option>
                            <option value="DE">Delaware (DE)</option>
                            <option value="DC">Washington D.C.</option>
                            <option value="WV">West Virginia (WV)</option>
                            <option value="NJ">New Jersey (NJ)</option>
                            <option value="NY">New York (NY)</option>
                            <option value="OH">Ohio (OH)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div id="otherStateContainer" class="hidden">
                        <label for="otherState" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Specify State*</label>
                        <input type="text" id="otherState" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="newBreweryAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Address*</label>
                    <input type="text" id="newBreweryAddress" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" required placeholder="Street, City, State, ZIP">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="newBreweryLat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Latitude*</label>
                        <input type="number" id="newBreweryLat" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" required step="any" placeholder="e.g. 39.2092">
                    </div>
                    <div>
                        <label for="newBreweryLng" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Longitude*</label>
                        <input type="number" id="newBreweryLng" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" required step="any" placeholder="e.g. -76.8605">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="newBreweryFlagshipBeer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Flagship/Notable Beers</label>
                    <textarea id="newBreweryFlagshipBeer" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" placeholder="List flagship beers, styles, awards, etc."></textarea>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="newBreweryVisited" class="form-checkbox h-5 w-5 text-primary">
                        <label for="newBreweryVisited" class="ml-2">Already Visited</label>
                    </div>
                    <div id="newBreweryVisitDateContainer" class="hidden">
                        <label for="newBreweryVisitDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date Visited</label>
                        <input type="date" id="newBreweryVisitDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base">
                    </div>
                </div>
                
                <div>
                    <label for="newBreweryNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                    <textarea id="newBreweryNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base"></textarea>
                </div>
                
                <div class="flex justify-between mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button id="geolocateAddress" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        Get Coordinates from Address
                    </button>
                    <button id="addNewBrewery" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">
                        Add Brewery
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dropbox File Chooser -->
    <div id="fileChooserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2001] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full shadow-xl mx-4">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <svg class="h-6 w-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#0061fe">
                    <path d="M12 2L6 7l6 5-6 5 6 5 6-5-6-5 6-5-6-5z"/>
                </svg>
                Select Dropbox File
            </h3>
            <p class="mb-4">Please select your brewery data file:</p>
            
            <div class="mb-4 overflow-y-auto max-h-60 border border-gray-200 dark:border-gray-700 rounded-md">
                <div id="fileList" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <div class="p-4 flex items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                        brewery_data.json
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col">
                <div class="mb-2">
                    <label for="customFilePath" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Or enter file path manually:</label>
                    <input type="text" id="customFilePath" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 text-base" placeholder="/Brewery Tracker/brewery_data.json">
                </div>
                
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="rememberFilePath" class="form-checkbox h-4 w-4 text-primary" checked>
                    <label for="rememberFilePath" class="ml-2 text-sm">Remember this file for future loads</label>
                </div>
            </div>
            
            <div class="mt-4 flex justify-end space-x-3">
                <button id="cancelChooserBtn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-white rounded">Cancel</button>
                <button id="chooseFileBtn" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Choose File</button>
            </div>
        </div>
    </div>

    <!-- Dropbox Notification -->
    <div id="dropboxNotification" class="dropbox-notification">
        <div class="flex items-start">
            <div class="flex-shrink-0 mr-3">
                <svg class="h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L6 7l6 5-6 5 6 5 6-5-6-5 6-5-6-5z"/>
                </svg>
            </div>
            <div class="flex-1">
                <h4 class="text-base font-medium">Dropbox Update Available</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">A newer version of the brewery data is available.</p>
                <div class="flex space-x-3">
                    <button id="loadUpdateBtn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                        Load Update
                    </button>
                    <button id="dismissUpdateBtn" class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="spinner mb-4 w-12 h-12"></div>
            <p id="loadingMessage" class="text-lg font-semibold">Loading data...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" class="hidden">

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Check for dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initial breweries data
        const initialBreweries = [
            // Maryland Breweries
            { name: "Sapwood Cellars Brewery", rank: 1, city: "Columbia", state: "MD", address: "8980 MD-108 Suite MNO, Columbia, MD 21045", lat: 39.2092, lng: -76.8605, distance: 5, flagshipBeer: "Snip Snap (DIPA - Citra, Galaxy), Rings of Light (DDH Citra pale ale), Pillowfort (Imperial DIPA - Citra, Azacca)" },
            { name: "Guinness Open Gate Brewery", rank: 2, city: "Halethorpe", state: "MD", address: "5001 Washington Blvd, Halethorpe, MD 21227", lat: 39.2275, lng: -76.6945, distance: 10, flagshipBeer: "Baltimore Blonde, Guinness Draught Stout, Over the Moon Milk Stout, Barrel-Aged Stock Ale" },
            { name: "Burley Oak Brewing Company", rank: 3, city: "Berlin", state: "MD", address: "10016 Old Ocean City Blvd, Berlin, MD 21811", lat: 38.3214, lng: -75.2182, distance: 130, flagshipBeer: "Lost IPA (hazy), Sorry Chicky (dry-hopped sour), J.R.E.A.M. series, Fruited sours (e.g. mango apricot pineapple)" },
            { name: "Cushwa Brewing Company", rank: 4, city: "Williamsport", state: "MD", address: "10210 Governor Lane Blvd, Williamsport, MD 21795", lat: 39.5985, lng: -77.8074, distance: 70, flagshipBeer: "Cush (hazy IPA - Simcoe, Mosaic), Face Chop (DIPA), Fog At Daybreak (pale ale), Cali Cush (West Coast IPA)" },
            { name: "Black Flag Brewing Co.", rank: 5, city: "Columbia", state: "MD", address: "9315 Snowden River Pkwy, Columbia, MD 21046", lat: 39.1916, lng: -76.8179, distance: 5, flagshipBeer: "Flagship IPA, Glen Cocoa (milk stout), Brunch (coffee stout), Z Morris (blonde ale), Rainbow Road (hazy pale ale)" },
            { name: "Elder Pine Brewing & Blending Co.", rank: 6, city: "Gaithersburg", state: "MD", address: "4200 Sundown Rd, Gaithersburg, MD 20882", lat: 39.1826, lng: -77.1763, distance: 30, flagshipBeer: "Baltic porter, Lagers, Saisons, Barrel-aged beers, IPAs (some with Kveik yeast)" },
            { name: "Nepenthe Brewing Co.", rank: 7, city: "Baltimore", state: "MD", address: "3626 Falls Rd, Baltimore, MD 21211", lat: 39.3305, lng: -76.6316, distance: 15, flagshipBeer: "Space Jellyfish (hazy IPA - Galaxy, Motueka, Simcoe), Cryomancer (West Coast IPA), Strange Beast (rice lager)" },
            { name: "Jailbreak Brewing Company", rank: 8, city: "Laurel", state: "MD", address: "9445 Washington Blvd N, Laurel, MD 20723", lat: 39.1215, lng: -76.8512, distance: 10, flagshipBeer: "Feed The Monkey (hefeweizen), The Infinite (amber ale), Big Punisher (DIPA), Poor Righteous (West Coast IPA)" },
            { name: "Crooked Crab Brewing Company", rank: 9, city: "Odenton", state: "MD", address: "8251 Telegraph Rd Suite D, Odenton, MD 21113", lat: 39.0845, lng: -76.7001, distance: 15, flagshipBeer: "Haze for Days (hazy IPA), Crooked Cream Ale, High Joltage (coffee stout), Chuck Brown Ale, Furious George (hefeweizen)" },
            { name: "Heavy Seas Beer", rank: 10, city: "Halethorpe", state: "MD", address: "4615 Hollins Ferry Rd, Halethorpe, MD 21227", lat: 39.2353, lng: -76.6798, distance: 10, flagshipBeer: "Loose Cannon IPA (flagship), TropiCannon (citrus IPA), Double Cannon (DIPA), Hazy Cannon" },
            { name: "Union Craft Brewing", rank: 11, city: "Baltimore", state: "MD", address: "1700 W 41st St, Baltimore, MD 21211", lat: 39.3343, lng: -76.6346, distance: 15, flagshipBeer: "Duckpin Pale Ale (flagship), Divine IPA, Skipjack Pilsner, Testudo Premium Lager" },
            { name: "Idiom Brewing Co.", rank: 12, city: "Frederick", state: "MD", address: "340 E Patrick St, Frederick, MD 21701", lat: 39.4143, lng: -77.4047, distance: 40, flagshipBeer: "Kindred Spirits (NEIPA), It's the Berries (fruited sour), Generational Gap (NEIPA), Darkest Hour (Schwarzbier)" },
            { name: "Checkerspot Brewing Company", rank: 13, city: "Baltimore", state: "MD", address: "1421 Ridgely St, Baltimore, MD 21230", lat: 39.2746, lng: -76.6208, distance: 15, flagshipBeer: "Juniperus IPA, Fancy Pants (NEIPA), Hillbilly Gold (pilsner), Bird Is the Word (honey Kölsch). Gluten-reduced" },
            { name: "Ten Eyck Brewing Company", rank: 14, city: "Queenstown", state: "MD", address: "205 Grange Hall Rd, Queenstown, MD 21658", lat: 38.9833, lng: -76.1663, distance: 50, flagshipBeer: "Taildragger IPA (hazy), Tmavé Pivo (Czech dark lager - World Beer Cup bronze 2023), Side Dish (imperial brown ale), PIE. series (fruited sours)" },
            { name: "Brookeville Beer Farm", rank: 15, city: "Brookeville", state: "MD", address: "20315 Georgia Ave, Brookeville, MD 20833", lat: 39.1901, lng: -77.0588, distance: 20, flagshipBeer: "Interdependence IPA (flagship - Mosaic), Hop Envy (NEIPA), Dewpoint Pale Ale, Happenchance Whitbier" },
            { name: "Waredaca Brewing Company", rank: 16, city: "Laytonsville", state: "MD", address: "4017 Damascus Rd, Laytonsville, MD 20882", lat: 39.2185, lng: -77.1420, distance: 20, flagshipBeer: "Pale Ale, Beecher IPA (estate lemon verbena), Little Dam (honey wheat), Reveille (coffee stout), Baymore (NEIPA)" },
            { name: "Saints Row Brewing", rank: 17, city: "Rockville", state: "MD", address: "1211 Taft St, Rockville, MD 20850", lat: 39.0853, lng: -77.1537, distance: 30, flagshipBeer: "Rainbow Connection (hazy IPA), That Irish Goodbye (dry stout), Free State Pilsner, Lechismo (horchata ale)" },
            { name: "Evolution Craft Brewing", rank: 18, city: "Salisbury", state: "MD", address: "201 E Vine St, Salisbury, MD 21804", lat: 38.3666, lng: -75.5937, distance: 100, flagshipBeer: "Lot No. 3 IPA (flagship), Lot No. 6 DIPA, Pine'hop'le IPA, Primal Pale Ale, Lucky 7 Porter, Rise Up Coffee Stout" },
            { name: "RAR Brewing", rank: 19, city: "Cambridge", state: "MD", address: "504 Poplar St, Cambridge, MD 21613", lat: 38.5732, lng: -76.0777, distance: 80, flagshipBeer: "Nanticoke Nectar (IPA - flagship), Groove City Hefeweizen, Pulp (hazy pale ale), Bucktown Brown, Out of Order series (fruited sours)" },
            { name: "Brewery Fire", rank: 20, city: "Taneytown", state: "MD", address: "120 E Baltimore St, Taneytown, MD 21787", lat: 39.6573, lng: -77.1701, distance: 40, flagshipBeer: "Executor IPA (flagship - West Coast), Cowabunga Dude (NEIPA), The Mangolorian (mango IPA)" },
            { name: "Peabody Heights Brewery", rank: 21, city: "Baltimore", state: "MD", address: "401 E 30th St, Baltimore, MD 21218", lat: 39.3273, lng: -76.6100, distance: 15, flagshipBeer: "Astrodon (hazy IPA), Mr. Trash Wheel's Lost Python Ale (session IPA), Unforgivable Curses (Belgian Tripel). Co-op" },
            { name: "Independent Brewing Company", rank: 22, city: "Bel Air", state: "MD", address: "418 N Main St, Bel Air, MD 21014", lat: 39.5413, lng: -76.3492, distance: 30, flagshipBeer: "Carpe Diem (DIPA), Blue Eyed Blonde, Cereal Killer (oatmeal stout), Straight Up Cider. Many gluten-free options" },
            { name: "Manor Hill Brewing", rank: 23, city: "Ellicott City", state: "MD", address: "4411 Manor Ln, Ellicott City, MD 21042", lat: 39.2682, lng: -76.8941, distance: 5, flagshipBeer: "Manor Hill IPA, Farm Fuzz (Belgian wheat with peach). Farm brewery" },
            { name: "Eastern Shore Brewing", rank: 24, city: "St. Michaels", state: "MD", address: "605 S Talbot St, St. Michaels, MD 21663", lat: 38.7831, lng: -76.2236, distance: 60, flagshipBeer: "St. Michaels Ale (award-winning amber), Situation Critical IPA" },
            { name: "Hopkins Farm Brewery", rank: 25, city: "Havre de Grace", state: "MD", address: "3833 Rider Ln, Havre de Grace, MD 21078", lat: 39.5594, lng: -76.1368, distance: 40, flagshipBeer: "Rapture (Belgian-style), Desperado Lager, HazerBeam IPA. Uses on-site barley" },
            { name: "Pickett Brewing Company", rank: 26, city: "Baltimore", state: "MD", address: "1130 S Paca St, Baltimore, MD 21230", lat: 39.2817, lng: -76.6251, distance: 15, flagshipBeer: "American and European-style ales and lagers" },
            { name: "Silver Branch Brewing Company", rank: 27, city: "Silver Spring", state: "MD", address: "8401 Colesville Rd, Silver Spring, MD 20910", lat: 38.9958, lng: -77.0263, distance: 20, flagshipBeer: "Glass Castle (Czech pilsner), Dr. Juicy (NEIPA)" },
            { name: "Attaboy Beer", rank: 28, city: "Frederick", state: "MD", address: "400 Sagner Ave, Frederick, MD 21701", lat: 39.4216, lng: -77.4211, distance: 40, flagshipBeer: "Rotating: NEIPAs, cold IPAs, West Coast pilsners, Belgian-inspired" },
            { name: "Mully's Brewery", rank: 29, city: "Prince Frederick", state: "MD", address: "141 Schooner Ln, Prince Frederick, MD 20678", lat: 38.5550, lng: -76.5892, distance: 60, flagshipBeer: "Blood Orange Blonde, Hazy Not Lazy IPA, Shucker Stout, FruiTart series" },
            { name: "Streetcar 82 Brewing Co.", rank: 30, city: "Hyattsville", state: "MD", address: "4824 Rhode Island Ave, Hyattsville, MD 20781", lat: 38.9534, lng: -76.9407, distance: 20, flagshipBeer: "Fancy Nancy Hazy IPA, The Colonel Pilsner, Pitmaster Smoked Lager. Deaf-owned" },
            
            // Pennsylvania Breweries
            { name: "Tröegs Independent Brewing", rank: 1, city: "Hershey", state: "PA", address: "200 E Hershey Park Dr, Hershey, PA 17033", lat: 40.2866, lng: -76.6513, distance: 90, flagshipBeer: "Perpetual IPA (flagship), Troegenator Double Bock, Mad Elf Ale, Nimble Giant Double IPA. Over 2.4M Untappd ratings. GABF Mid-Sized Brewery of the Year" },
            { name: "Brew Gentlemen", rank: 2, city: "Braddock", state: "PA", address: "512 Braddock Ave, Braddock, PA 15104", lat: 40.4013, lng: -79.8695, distance: 240, flagshipBeer: "General Braddock's IPA (flagship, 4.1 Untappd), Mr. Automatic porter, DoubleMex imperial stout. Untappd Community Awards medals" },
            { name: "Tired Hands Brewing Company", rank: 3, city: "Ardmore", state: "PA", address: "16 Ardmore Ave, Ardmore, PA 19003", lat: 40.0084, lng: -75.2927, distance: 100, flagshipBeer: "HopHands, Alien Church, Only Void, Milkshake IPAs. Over 1.7M Untappd ratings. Paste Magazine Top 50 (2010s)" },
            { name: "Dancing Gnome Brewery", rank: 4, city: "Pittsburgh", state: "PA", address: "925 Main St, Pittsburgh, PA 15215", lat: 40.4972, lng: -79.9283, distance: 240, flagshipBeer: "Lustra (flagship pale ale), Jam series IPAs, Black Clouds Breakfast Stout. Fern Hollow TIPA (high ratings)" },
            { name: "Other Half Brewing", rank: 5, city: "Philadelphia", state: "PA", address: "1002 Canal St, Philadelphia, PA 19123", lat: 39.9664, lng: -75.1357, distance: 100, flagshipBeer: "All Citra Everything, Green City, Forever Ever (flagships). Hazy IPAs, pastry stouts" },
            { name: "Hidden River Brewing Company", rank: 6, city: "Douglassville", state: "PA", address: "1808 W Schuylkill Rd, Douglassville, PA 19518", lat: 40.2593, lng: -75.7232, distance: 110, flagshipBeer: "Built Upon Memory (hazy DIPA), Waiting for Ghosts (imperial stout). 28 awards (10 gold)" },
            { name: "The Referend Bier Blendery", rank: 7, city: "Kutztown", state: "PA", address: "159 Main St, Kutztown, PA 19530", lat: 40.5196, lng: -75.7760, distance: 120, flagshipBeer: "In Recognition (golden ale), The Years (blend). Spontaneous fermentation" },
            { name: "Fourscore Beer Company", rank: 8, city: "Gettysburg", state: "PA", address: "603 S Washington St, Gettysburg, PA 17325", lat: 39.8219, lng: -77.2304, distance: 60, flagshipBeer: "Ohhhh Jeeee (hazy IPA), Schmamba (fruited sour), Hop Hat (IPA). Avg Untappd rating >4.0 (128k+ ratings)" },
            { name: "Victory Brewing Company", rank: 9, city: "Downingtown", state: "PA", address: "420 Acorn Ln, Downingtown, PA 19335", lat: 40.0046, lng: -75.6936, distance: 100, flagshipBeer: "Golden Monkey, HopDevil IPA (Good Food Award, GABF medals), Prima Pils, DirtWolf DIPA" },
            { name: "Fermentery Form", rank: 10, city: "Philadelphia", state: "PA", address: "1700 N Palethorp St, Philadelphia, PA 19122", lat: 39.9763, lng: -75.1369, distance: 100, flagshipBeer: "Formation, Form to Table, Formhouse. Avg Untappd rating 4.16" },
            { name: "South County Brewing Company", rank: 11, city: "Fawn Grove", state: "PA", address: "170 Crossway Dr, Fawn Grove, PA 17321", lat: 39.7323, lng: -76.4482, distance: 50, flagshipBeer: "Peace Maker (NEIPA), Sonic Bloom (NEIPA), Virgil (Imperial Stout). Avg Untappd rating 3.99 (140k+ ratings)" },
            { name: "Human Robot Brewery", rank: 12, city: "Philadelphia", state: "PA", address: "1710 N 5th St, Philadelphia, PA 19122", lat: 39.9763, lng: -75.1431, distance: 100, flagshipBeer: "Czech 10° (Czech pale lager - 3rd place 2023 Breweries in PA Readers' Choice), Content Therapy (juicy DIPA). Avg Untappd rating >4.0 (90k+ ratings)" },
            { name: "Forest & Main Brewing Company", rank: 13, city: "Ambler", state: "PA", address: "61 N Main St, Ambler, PA 19002", lat: 40.1567, lng: -75.2196, distance: 100, flagshipBeer: "Solaire Reserve (foeder saison), The Lady (saison). Avg Untappd rating 3.95 (165k+ ratings)" },
            { name: "New Trail Brewing", rank: 14, city: "Williamsport", state: "PA", address: "240 Arch St, Williamsport, PA 17701", lat: 41.2369, lng: -77.0096, distance: 150, flagshipBeer: "Broken Heels (Hazy IPA - flagship), Barrel Aged Moonlit (stout). Avg Untappd rating 3.95 (773k+ ratings). GABF Gold (2019)" },
            { name: "Yards Brewing Company", rank: 15, city: "Philadelphia", state: "PA", address: "500 Spring Garden St, Philadelphia, PA 19123", lat: 39.9608, lng: -75.1449, distance: 100, flagshipBeer: "Philadelphia Pale Ale (flagship), Brawler English Mild, Ales of the Revolution series" },
            { name: "Rusty Rail Brewing Company", rank: 16, city: "Mifflinburg", state: "PA", address: "5 N 8th St, Mifflinburg, PA 17844", lat: 40.9153, lng: -77.0491, distance: 140, flagshipBeer: "Fool's Gold (Imperial Peanut Butter Hefeweizen - flagship), All Good (Hazy IPA). Avg Untappd rating 3.69 (327k+ ratings). 2017 Best of Craft Beer Awards medals" },
            { name: "Voodoo Brewery", rank: 17, city: "Meadville", state: "PA", address: "215 Arch St, Meadville, PA 16335", lat: 41.6415, lng: -80.1525, distance: 250, flagshipBeer: "Good Vibes (West Coast IPA - flagship), Voodoo Love Child (Belgian Tripel), ManBearPig (imperial stout). Lacto-Kooler (Best Beer Tampa Bay 2025). Avg Untappd rating 3.94 (567k+ ratings)" },
            { name: "Levante Brewing Company", rank: 18, city: "West Chester", state: "PA", address: "208 Carter Dr, West Chester, PA 19382", lat: 39.9596, lng: -75.5905, distance: 100, flagshipBeer: "Cloudy & Cumbersome (NEIPA - flagship), Tickle Parts (IPA - Grand Gold Frankfurt Int'l Beer Trophy). Avg Untappd rating 3.97 (523k+ ratings)" },
            { name: "Pizza Boy Brewing Co.", rank: 19, city: "Enola", state: "PA", address: "2240 Millennium Way, Enola, PA 17025", lat: 40.2920, lng: -76.9303, distance: 90, flagshipBeer: "Sunny Side Up (Double Coffee Stout), Murren River (IPA). Avg Untappd rating 3.87 (700k+ ratings)" },
            { name: "Grist House Craft Brewery", rank: 20, city: "Millvale", state: "PA", address: "10 E Sherman St, Millvale, PA 15209", lat: 40.4818, lng: -79.9763, distance: 240, flagshipBeer: "Hazedelic Juice Grenade (NEIPA). Avg Untappd score 4.0 (250k+ ratings)" },
            { name: "Broken Goblet Brewing", rank: 21, city: "Bensalem", state: "PA", address: "2500 State Rd, Bensalem, PA 19020", lat: 40.0733, lng: -74.9539, distance: 100, flagshipBeer: "Carle the Great (Russian Imperial Stout - award-winning), Harmonic Overtones (NEIPA). Avg Untappd score 3.77 (56k+ ratings)" },
            { name: "Warwick Farm Brewing", rank: 22, city: "Jamison", state: "PA", address: "800 Almshouse Rd, Jamison, PA 18929", lat: 40.2536, lng: -75.0731, distance: 100, flagshipBeer: "DDH Electric Countach (IPA), Hills of Hops & Haze (IPA). 4 Craft Beer Marketing Awards (2024), Platinum Crushie for Coolest Taproom" },
            { name: "Ever Grain Brewing Co.", rank: 23, city: "Camp Hill", state: "PA", address: "4444 Carlisle Pike, Camp Hill, PA 17011", lat: 40.2372, lng: -76.9363, distance: 90, flagshipBeer: "Fluffhead (Hefeweizen - award-winning), Joose Juicy (NEIPA). Best Can Design for Moire Eel DIPA" },
            { name: "Weyerbacher Brewing Company", rank: 24, city: "Easton", state: "PA", address: "905 Line St, Easton, PA 18042", lat: 40.6870, lng: -75.2323, distance: 120, flagshipBeer: "Merry Monks, QUAD, Blithering Idiot, Sunday Morning Stout (top-rated PA beer). Nearly 1M Untappd ratings. 3 Untappd Community Awards (2024)" },
            { name: "Sly Fox Brewing Company", rank: 25, city: "Phoenixville", state: "PA", address: "520 Kimberton Rd, Phoenixville, PA 19460", lat: 40.1244, lng: -75.5340, distance: 100, flagshipBeer: "Pikeland Pils (GABF medal 2007), Helles Golden Lager, Grisette" },
            { name: "Collusion Tap Works", rank: 26, city: "York", state: "PA", address: "105 S Howard St, York, PA 17401", lat: 39.9638, lng: -76.7271, distance: 60, flagshipBeer: "Homunculus (Imperial IPA), King Cuddly (fruited sour series). World Beer Cup & GABF accolades" },
            { name: "Imprint Beer Company", rank: 27, city: "Hatfield", state: "PA", address: "1500 Industry Rd, Hatfield, PA 19440", lat: 40.2843, lng: -75.2788, distance: 100, flagshipBeer: "Schmoojee series (fruited sours). 500k+ Untappd ratings. Untappd Community Awards medals" },
            { name: "Second Sin Brewing", rank: 28, city: "Bristol", state: "PA", address: "1500 Grundy Ln, Bristol, PA 19007", lat: 40.1055, lng: -74.8509, distance: 100, flagshipBeer: "Burgerstaxx (Hazy IPA - 1st place 2024 PA Farm Show), Tables, Lagers, & Chairs (Untappd Community Awards gold). Avg Untappd rating 4.09 (370+ beers)" },
            { name: "Free Will Brewing Co.", rank: 29, city: "Perkasie", state: "PA", address: "410 E Walnut St, Perkasie, PA 18944", lat: 40.3721, lng: -75.2882, distance: 100, flagshipBeer: "Kragle IPA (West Coast-style), Techno IPA, Ralphius Imperial Stout. Over 600k Untappd ratings" },
            { name: "D.G. Yuengling & Son", rank: 30, city: "Pottsville", state: "PA", address: "420 Mahantongo St, Pottsville, PA 17901", lat: 40.6896, lng: -76.1995, distance: 120, flagshipBeer: "Traditional Lager (flagship), Light Lager, Black & Tan. IFEA Pinnacle Award" },
            
            // Virginia Breweries
            { name: "The Veil Brewing Co.", rank: 1, city: "Richmond", state: "VA", address: "1301 Roseneath Rd, Richmond, VA 23230", lat: 37.5699, lng: -77.4734, distance: 140, flagshipBeer: "Master Shredder (hazy IPA - cantaloupe, orange), Crucial Taunt (DIPA - citrus, pineapple), Circle of Wolves (English Barleywine)" },
            { name: "Triple Crossing Brewing", rank: 2, city: "Richmond", state: "VA", address: "113 S Foushee St, Richmond, VA 23220", lat: 37.5415, lng: -77.4453, distance: 140, flagshipBeer: "Falcon Smash IPA (flagship - citrus, stone fruit), Last Broadcast (DIPA), Clever Girl (American IPA)" },
            { name: "The Answer Brewpub", rank: 3, city: "Richmond", state: "VA", address: "6008 W Broad St, Richmond, VA 23230", lat: 37.5925, lng: -77.5137, distance: 140, flagshipBeer: "Cosmic Gumbo (hazy IPA), Joose series (high-ABV fruit beers). Recognized as one of U.S. best brewpubs" },
            { name: "Hardywood Park Craft Brewery", rank: 4, city: "Richmond", state: "VA", address: "2410 Ownby Ln, Richmond, VA 23220", lat: 37.5664, lng: -77.4644, distance: 140, flagshipBeer: "Richmond Lager (flagship), Singel (Belgian blonde - flagship), VIPA, Gingerbread Stout" },
            { name: "Aslin Beer Company", rank: 5, city: "Alexandria", state: "VA", address: "847 S Pickett St, Alexandria, VA 22304", lat: 38.8065, lng: -77.1324, distance: 50, flagshipBeer: "Orange Starfish (DDH IPA), Power Move (IPA), Master of Oranges" },
            { name: "Port City Brewing Company", rank: 6, city: "Alexandria", state: "VA", address: "3950 Wheeler Ave, Alexandria, VA 22304", lat: 38.8147, lng: -77.1080, distance: 50, flagshipBeer: "Optimal Wit (flagship Belgian wheat), Monumental IPA, Port City Porter, Tidings Ale" },
            { name: "Devils Backbone Brewing Company", rank: 7, city: "Roseland", state: "VA", address: "200 Mosbys Run, Roseland, VA 22967", lat: 37.7863, lng: -79.4428, distance: 170, flagshipBeer: "Vienna Lager (flagship), Eight Point IPA, Danzig Baltic Porter" },
            { name: "Blue Mountain Brewery", rank: 8, city: "Afton", state: "VA", address: "9519 Critzers Shop Rd, Afton, VA 22920", lat: 38.0334, lng: -78.8393, distance: 160, flagshipBeer: "Full Nelson Pale Ale (flagship), Kölsch 151, Dark Hollow (imperial stout)" },
            { name: "Big Lick Brewing Company", rank: 9, city: "Roanoke", state: "VA", address: "409 Salem Ave SW, Roanoke, VA 24016", lat: 37.2714, lng: -79.9418, distance: 220, flagshipBeer: "White Bronco (NEIPA), Peace, Love & Hoppiness (imperial IPA), Popsicle Toes (milkshake IPA)" },
            { name: "The Virginia Beer Company", rank: 10, city: "Williamsburg", state: "VA", address: "401 2nd St, Williamsburg, VA 23185", lat: 37.2674, lng: -76.7004, distance: 160, flagshipBeer: "Free Verse (NEIPA), Gorgeous Citra IPA, Elbow Patches (oatmeal stout)" },
            { name: "Smartmouth Brewing Co.", rank: 11, city: "Norfolk", state: "VA", address: "1309 Raleigh Ave, Norfolk, VA 23507", lat: 36.8565, lng: -76.2919, distance: 190, flagshipBeer: "Alter Ego Saison, Notch 9 DIPA, Safety Dance Pilsner, Savage Mondo Hazy IPA" },
            { name: "Ocelot Brewing Company", rank: 12, city: "Dulles", state: "VA", address: "23600 Overland Dr, Dulles, VA 20166", lat: 38.9774, lng: -77.4474, distance: 40, flagshipBeer: "Mr. Kite (American IPA), Sunnyside Dweller (Pilsner - GABF gold), Misunderstood (hazy IPA)" },
            { name: "Väsen Brewing Company", rank: 13, city: "Richmond", state: "VA", address: "3331 W Moore St, Richmond, VA 23230", lat: 37.5666, lng: -77.4726, distance: 140, flagshipBeer: "Hefeweizen, Cashmere Secrets (hazy DIPA), Key Lime Sour, Neomexicanus (hazy DIPA)" },
            { name: "Starr Hill Brewery", rank: 14, city: "Crozet", state: "VA", address: "5391 Three Notched Rd, Crozet, VA 22932", lat: 38.0725, lng: -78.7014, distance: 15, flagshipBeer: "Northern Lights (IPA - flagship), The Love (hefeweizen), Little Red RooStarr (coffee cream stout)" },
            { name: "Strangeways Brewing", rank: 15, city: "Richmond", state: "VA", address: "2277 Dabney Rd, Richmond, VA 23230", lat: 37.5751, lng: -77.4748, distance: 140, flagshipBeer: "Hop Howler (IPA), Albino Monkey (Belgian White), Woodbooger (Belgian Brown)" },
            { name: "Alewerks Brewing Company", rank: 16, city: "Williamsburg", state: "VA", address: "189B Ewell Rd, Williamsburg, VA 23188", lat: 37.3269, lng: -76.7747, distance: 160, flagshipBeer: "Pumpkin Ale (seasonal), Bitter Valentine DIPA, Superb IPA, Tavern Brown Ale" },
            { name: "Dirt Farm Brewing", rank: 17, city: "Bluemont", state: "VA", address: "18701 Foggy Bottom Rd, Bluemont, VA 20135", lat: 39.1110, lng: -77.8339, distance: 50, flagshipBeer: "Red Merl (Irish Red Ale), Fluster Cluck (seasonal fruit beer), Som' Peach (summer ale)" },
            { name: "Benchtop Brewing Company", rank: 18, city: "Norfolk", state: "VA", address: "1129 Boissevain Ave, Norfolk, VA 23507", lat: 36.8638, lng: -76.2899, distance: 190, flagshipBeer: "Proven Theory (American IPA), Gong Water (hazy IPA), Walter's Brunch (coffee porter)" },
            { name: "Precarious Beer Project", rank: 19, city: "Williamsburg", state: "VA", address: "110 S Henry St, Williamsburg, VA 23185", lat: 37.2707, lng: -76.7074, distance: 160, flagshipBeer: "Kung Fu Kittens (NEIPA), Everything Is Lava But the Swings Are Base (imperial IPA)" },
            { name: "Ardent Craft Ales", rank: 20, city: "Richmond", state: "VA", address: "3200 W Leigh St, Richmond, VA 23230", lat: 37.5680, lng: -77.4731, distance: 140, flagshipBeer: "Ardent IPA (Citra IPA), Ardent Pilsner, Honey Ginger" },
            { name: "Final Gravity Brewing Co.", rank: 21, city: "Richmond", state: "VA", address: "6118 Lakeside Ave, Richmond, VA 23228", lat: 37.6136, lng: -77.4650, distance: 140, flagshipBeer: "Venus Rising DIPA, Doppler Effect (American IPA), Fast Machine Hoppy Pilsner" },
            { name: "New Realm Brewing", rank: 22, city: "Virginia Beach", state: "VA", address: "1209 Craft Ln, Virginia Beach, VA 23454", lat: 36.8434, lng: -76.0328, distance: 200, flagshipBeer: "Hazy Like a Fox (NEIPA), Hoplandia (West Coast IPA), Tart Blossoms Imperial Sour" },
            { name: "Caboose Brewing Company", rank: 23, city: "Vienna", state: "VA", address: "520 Mill St NE, Vienna, VA 22180", lat: 38.9032, lng: -77.2588, distance: 40, flagshipBeer: "Vienna, VA Lager (multi-gold Virginia Craft Brewers Cup), Bienvenidos Mexican Lager, Blackberry Gose" },
            { name: "Harpers Ferry Brewing", rank: 24, city: "Purcellville", state: "VA", address: "37412 Adventure Center Ln, Purcellville, VA 20132", lat: 39.3151, lng: -77.7392, distance: 50, flagshipBeer: "Mountain Juice (NEIPA), The Needles (American IPA), Dewbrew Blonde Ale" },
            { name: "Crooked Run Brewing", rank: 25, city: "Sterling", state: "VA", address: "22455 Davis Dr, Sterling, VA 20164", lat: 39.0347, lng: -77.4287, distance: 40, flagshipBeer: "Diverse range: traditional, barrel-aged stouts, coolship sours" },
            { name: "Decipher Brewing", rank: 26, city: "Charlottesville", state: "VA", address: "1740 Broadway St, Charlottesville, VA 22902", lat: 38.0156, lng: -78.4813, distance: 150, flagshipBeer: "Barley Late Kölsch (Virginia Craft Beer Cup top honors), Babington Project (barrel-aged series)" },
            { name: "Juicy Brewing", rank: 27, city: "Herndon", state: "VA", address: "14140 Parke Long Ct, Herndon, VA 20170", lat: 38.9502, lng: -77.4175, distance: 40, flagshipBeer: "Oppaque series (NEIPAs), Mega Fresh & Mega Fruit series (fruited sours)" },
            { name: "The Garage Brewery", rank: 28, city: "Chesapeake", state: "VA", address: "1011 Eden Way N, Chesapeake, VA 23320", lat: 36.7695, lng: -76.2391, distance: 190, flagshipBeer: "Rotating selection of IPAs to lagers" },
            { name: "Commonwealth Brewing Co.", rank: 29, city: "Virginia Beach", state: "VA", address: "2444 Pleasure House Rd, Virginia Beach, VA 23455", lat: 36.9070, lng: -76.1237, distance: 200, flagshipBeer: "Rotating selection: crisp lagers, bold IPAs, complex sours" },
            { name: "Adroit Theory Brewing Company", rank: 30, city: "Purcellville", state: "VA", address: "404 Browning Ct Unit C, Purcellville, VA 20132", lat: 39.1375, lng: -77.6960, distance: 50, flagshipBeer: "High-alcohol beers: hazy IPAs, fruited sours, pastry stouts, barrel-aged" }
        ];

        // Dropbox settings
        let dropboxSettings = {
            autoLoadEnabled: false,
            lastUsedFilePath: '/Brewery Tracker/brewery_data.json',
            lastLoadTimestamp: null
        };

        function loadDropboxSettings() {
            const savedSettings = localStorage.getItem('dropboxSettings');
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);
                    dropboxSettings = { ...dropboxSettings, ...parsed };
                    
                    // Update UI based on loaded settings
                    document.getElementById('autoLoadDropbox').checked = dropboxSettings.autoLoadEnabled;
                    if (dropboxSettings.autoLoadEnabled) {
                        document.getElementById('autosyncBadge').classList.remove('hidden');
                    }
                } catch (e) {
                    console.error("Error parsing dropbox settings:", e);
                }
            }
        }

        function saveDropboxSettings() {
            try {
                localStorage.setItem('dropboxSettings', JSON.stringify(dropboxSettings));
                return true;
            } catch (e) {
                console.error("Error saving dropbox settings:", e);
                return false;
            }
        }

        // Initialize breweries with default values
        function initializeBreweryData() {
            // Either load from localStorage or use default data
            let savedData = null;
            try {
                const saved = localStorage.getItem('breweryData');
                if (saved) {
                    savedData = JSON.parse(saved);
                }
            } catch (e) {
                console.error("Error reading from localStorage:", e);
            }
            
            if (savedData) {
                return savedData;
            }
            
            return initialBreweries.map(brewery => ({
                ...brewery,
                visited: false,
                visitDate: null,
                ratings: { KC: 0, Jeff: 0, Dave: 0 },
                avgRating: 0,
                notes: '',
                untappdURL: ''
            }));
        }

        // Show/hide loading indicator
        function showLoading(message = "Loading data...") {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set message and type
            toastMessage.textContent = message;
            toast.className = 'toast ' + type;
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
                
                // Hide toast after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }, 100);
        }
        
        // Show Dropbox notification
        function showDropboxNotification() {
            const notification = document.getElementById('dropboxNotification');
            notification.classList.add('show');
        }

        function hideDropboxNotification() {
            const notification = document.getElementById('dropboxNotification');
            notification.classList.remove('show');
        }
        
        // Save data to localStorage
        function saveToStorage() {
            try {
                localStorage.setItem('breweryData', JSON.stringify(breweries));
                return true;
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                return false;
            }
        }

        // Save to Dropbox folder
        function saveToDropbox() {
            try {
                const dataStr = JSON.stringify(breweries, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                // Create a download link
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = "brewery_data.json";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
                
                // Update last save timestamp
                const now = new Date();
                dropboxSettings.lastSaveTimestamp = now.getTime();
                saveDropboxSettings();
                
                showToast(`Please save this file to your Dropbox folder at: ${dropboxSettings.lastUsedFilePath}`, 'info');
            } catch (error) {
                console.error('Error saving to Dropbox:', error);
                showToast('Error saving data. Please try again.', 'error');
            }
        }
        
        // Show the file chooser modal
        function showFileChooser() {
            // Update the file list with the last used path
            document.getElementById('customFilePath').value = dropboxSettings.lastUsedFilePath;
            document.getElementById('fileChooserModal').classList.remove('hidden');
        }
        
        // Load data from Dropbox file
        function loadFromDropbox(file) {
            try {
                if (!file) {
                    // If no file provided, trigger file input
                    document.getElementById('fileInput').click();
                    return;
                }
                
                showLoading("Loading data from Dropbox...");
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Replace breweries
                        breweries = importedData;
                        
                        // Save to localStorage
                        saveToStorage();
                        
                        // Reset map and rebuild UI
                        markers.forEach(m => map.removeLayer(m.marker));
                        markers.length = 0;
                        initializeBreweries();
                        
                        // Update last load timestamp
                        const now = new Date();
                        dropboxSettings.lastLoadTimestamp = now.getTime();
                        saveDropboxSettings();
                        
                        hideLoading();
                        showToast('Data loaded successfully from Dropbox!', 'success');
                        hideDropboxNotification();
                    } catch (parseError) {
                        console.error('Error parsing imported data:', parseError);
                        hideLoading();
                        showToast('Invalid file format. Please select a valid brewery tracker JSON file.', 'error');
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error loading from Dropbox:', error);
                hideLoading();
                showToast('Error loading data. Please try again.', 'error');
            }
        }
        
        // Set up auto-loading from Dropbox
        function setupAutoLoad() {
            if (dropboxSettings.autoLoadEnabled) {
                // Show badge on the Dropbox button
                document.getElementById('autosyncBadge').classList.remove('hidden');
                
                // If we have a last load timestamp, check for updates periodically
                if (dropboxSettings.lastLoadTimestamp) {
                    checkForUpdates();
                    
                    // Set up interval to check for updates (every 5 minutes)
                    setInterval(checkForUpdates, 5 * 60 * 1000);
                }
            }
        }
        
        // Function to check if Dropbox file has been updated
        function checkForUpdates() {
            // Since we can't directly check the Dropbox file, we'll show a notification
            // when the app is opened reminding the user to check for updates
            // In a real implementation, this would check the file's last modified date
            
            // For simulation purposes, let's say there's a 30% chance of an update being available
            if (Math.random() < 0.3) {
                showDropboxNotification();
            }
        }
        
        // Export breweries data as a JSON file for the user to save
        function exportBreweryData(breweries) {
            try {
                const dataStr = JSON.stringify(breweries, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = 'brewery_tracker_data.json';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
                
                showToast('Data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting brewery data:', error);
                showToast('Error exporting data. Please try again.', 'error');
            }
        }
        
        // Import breweries data from a JSON file
        function importBreweryData(event) {
            try {
                showLoading("Importing data...");
                
                const file = event.target.files[0];
                if (!file) {
                    hideLoading();
                    return;
                }
                
                // If this is being called for Dropbox loading
                if (event.target.dataset.purpose === 'dropbox') {
                    // Update path if remember option is checked
                    if (document.getElementById('rememberFilePath').checked) {
                        dropboxSettings.lastUsedFilePath = document.getElementById('customFilePath').value;
                        saveDropboxSettings();
                    }
                    
                    loadFromDropbox(file);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Confirm before overwriting
                        if (!confirm("This will replace all brewery data. Continue?")) {
                            hideLoading();
                            return;
                        }
                        
                        // Replace breweries
                        breweries = importedData;
                        
                        // Save to localStorage
                        saveToStorage();
                        
                        // Reset map and rebuild UI
                        markers.forEach(m => map.removeLayer(m.marker));
                        markers.length = 0;
                        initializeBreweries();
                        
                        hideLoading();
                        showToast('Data imported successfully!', 'success');
                    } catch (parseError) {
                        console.error('Error parsing imported data:', parseError);
                        hideLoading();
                        showToast('Invalid file format. Please select a valid brewery tracker JSON file.', 'error');
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error importing brewery data:', error);
                hideLoading();
                showToast('Error importing data. Please try again.', 'error');
            }
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'Not visited';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format rating for display
        function formatRating(rating) {
            if (!rating || rating === 0) return 'Not rated';
            return rating.toFixed(1);
        }

        // Create beer mug rating HTML
        function createRatingMugs(containerId, person, brewery) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const mug = document.createElement('div');
                mug.className = `rating-mug ${brewery.ratings[person] >= i ? 'selected' : 'unselected'}`;
                mug.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#f8b64c">
                        <path d="M4,2H19L17,22H6L4,2M6.2,4L7.8,20H8.8L7.43,6.34C8.5,6 9,5 9,4H6.2M9.9,4L11.4,20H12.5L11,4H9.9M16,4L14.6,20H15.6L17.2,4H16M20,2H22V4H20V2M20,10H22V12H20V10M20,18H22V20H20V18Z" />
                    </svg>
                `;
                
                mug.dataset.rating = i;
                mug.dataset.person = person;
                
                mug.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    const personName = this.dataset.person;
                    
                    // Check if this rating is already selected (allow deselection)
                    if (currentBrewery.ratings[personName] === rating) {
                        // Deselect/reset the rating
                        currentBrewery.ratings[personName] = 0;
                    } else {
                        // Set new rating
                        currentBrewery.ratings[personName] = rating;
                    }
                    
                    // Calculate average
                    const ratings = Object.values(currentBrewery.ratings);
                    const validRatings = ratings.filter(r => r > 0);
                    currentBrewery.avgRating = validRatings.length > 0 ? 
                        validRatings.reduce((sum, r) => sum + r, 0) / validRatings.length : 0;
                    
                    // Update UI
                    updateRatingUI(currentBrewery);
                });
                
                container.appendChild(mug);
            }
        }

        // Update rating UI
        function updateRatingUI(brewery) {
            // Update individual ratings
            for (const person of ['KC', 'Jeff', 'Dave']) {
                const container = document.getElementById(`${person.toLowerCase()}Rating`);
                const mugs = container.querySelectorAll('.rating-mug');
                
                mugs.forEach((mug, index) => {
                    if (brewery.ratings[person] >= index + 1) {
                        mug.classList.add('selected');
                        mug.classList.remove('unselected');
                    } else {
                        mug.classList.add('unselected');
                        mug.classList.remove('selected');
                    }
                });
            }
            
            // Update average
            const avgElement = document.getElementById('avgRating');
            if (brewery.avgRating > 0) {
                avgElement.textContent = brewery.avgRating.toFixed(1) + ' / 5.0';
            } else {
                avgElement.textContent = 'Not rated';
            }
        }

        // Calculate statistics
        function calculateStats(breweries) {
            // Count visited breweries
            const visitedCount = breweries.filter(b => b.visited).length;
            const visitedPercentage = (visitedCount / breweries.length * 100).toFixed(1);
            
            // Calculate average rating
            const ratedBreweries = breweries.filter(b => b.avgRating > 0);
            const avgOverallRating = ratedBreweries.length > 0 ? 
                ratedBreweries.reduce((sum, b) => sum + b.avgRating, 0) / ratedBreweries.length : 0;
            
            // Get top rated breweries
            const topRated = [...breweries]
                .filter(b => b.avgRating > 0)
                .sort((a, b) => b.avgRating - a.avgRating)
                .slice(0, 5);
            
            // Get recent visits
            const recentVisits = [...breweries]
                .filter(b => b.visited && b.visitDate)
                .sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate))
                .slice(0, 5);
            
            // Count breweries by state
            const stateCount = {};
            breweries.forEach(b => {
                stateCount[b.state] = (stateCount[b.state] || 0) + 1;
            });
            const stateVisited = {};
            breweries.filter(b => b.visited).forEach(b => {
                stateVisited[b.state] = (stateVisited[b.state] || 0) + 1;
            });
            
            return {
                totalBreweries: breweries.length,
                visitedCount,
                visitedPercentage,
                avgOverallRating,
                topRated,
                recentVisits,
                stateCount,
                stateVisited
            };
        }

        // Update statistics UI
        function updateStatsUI(stats) {
            // Update progress bar
            document.getElementById('progressBar').style.width = `${stats.visitedPercentage}%`;
            document.getElementById('progressText').textContent = 
                `${stats.visitedCount} of ${stats.totalBreweries} breweries visited (${stats.visitedPercentage}%)`;
            
            // Update average rating
            document.getElementById('avgOverallRating').textContent = 
                stats.avgOverallRating > 0 ? stats.avgOverallRating.toFixed(1) + ' / 5.0' : 'No ratings yet';
            
            // Update top rated breweries
            const topRatedList = document.getElementById('topRatedList');
            topRatedList.innerHTML = '';
            
            if (stats.topRated.length > 0) {
                stats.topRated.forEach(brewery => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between';
                    li.innerHTML = `
                        <span>${brewery.name}</span>
                        <span class="font-bold">${brewery.avgRating.toFixed(1)}</span>
                    `;
                    li.addEventListener('click', () => openBreweryDetails(brewery));
                    topRatedList.appendChild(li);
                });
            } else {
                topRatedList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 italic">No rated breweries yet</li>';
            }
            
            // Update recent visits
            const recentVisitsList = document.getElementById('recentVisitsList');
            recentVisitsList.innerHTML = '';
            
            if (stats.recentVisits.length > 0) {
                stats.recentVisits.forEach(brewery => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between';
                    li.innerHTML = `
                        <span>${brewery.name}</span>
                        <span class="text-gray-500 dark:text-gray-400">${formatDate(brewery.visitDate)}</span>
                    `;
                    li.addEventListener('click', () => openBreweryDetails(brewery));
                    recentVisitsList.appendChild(li);
                });
            } else {
                recentVisitsList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 italic">No visited breweries yet</li>';
            }
            
            // Update state breakdown
            const stateBreakdown = document.getElementById('stateBreakdown');
            stateBreakdown.innerHTML = '';
            
            Object.keys(stats.stateCount).sort().forEach(state => {
                const visited = stats.stateVisited[state] || 0;
                const total = stats.stateCount[state];
                const percentage = (visited / total * 100).toFixed(0);
                
                stateBreakdown.innerHTML += `
                    <div>${state}: ${visited}/${total} (${percentage}%)</div>
                `;
            });
        }

        // Define beer mug icons with better visibility
        const emptyBeerIcon = L.divIcon({
            html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="#888888" class="beer-mug-empty" style="filter:drop-shadow(0px 0px 2px rgba(0,0,0,0.5));"><path d="M4,2H19L17,22H6L4,2M6.2,4L7.8,20H8.8L7.43,6.34C8.5,6 9,5 9,4H6.2M9.9,4L11.4,20H12.5L11,4H9.9M16,4L14.6,20H15.6L17.2,4H16M20,2H22V4H20V2M20,10H22V12H20V10M20,18H22V20H20V18Z" stroke="#333" stroke-width="0.5"/></svg>',
            className: '',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        const fullBeerIcon = L.divIcon({
            html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="#3b82f6" class="beer-mug-full" style="filter:drop-shadow(0px 0px 2px rgba(0,0,0,0.5));"><path d="M4,2H19L17,22H6L4,2M6.2,4L7.8,20H8.8L7.43,6.34C8.5,6 9,5 9,4H6.2M9.9,4L11.4,20H12.5L11,4H9.9M16,4L14.6,20H15.6L17.2,4H16M20,2H22V4H20V2M20,10H22V12H20V10M20,18H22V20H20V18Z" stroke="#333" stroke-width="0.5"/></svg>',
            className: '',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        // Create brewery marker
        function createBreweryMarker(brewery) {
            const icon = brewery.visited ? fullBeerIcon : emptyBeerIcon;
            
            const marker = L.marker([brewery.lat, brewery.lng], {
                icon: icon,
                title: brewery.name
            });
            
            // Create popup content with flagship beer preview
            const flagshipPreview = brewery.flagshipBeer ? 
                `<p><strong>Flagship Beer:</strong> ${brewery.flagshipBeer.split(',')[0].trim()}${brewery.flagshipBeer.includes(',') ? '...' : ''}</p>` : '';
            
            const popupContent = `
                <div class="brewery-popup">
                    <h3>${brewery.name}</h3>
                    <p><strong>Rank:</strong> ${brewery.rank}</p>
                    <p><strong>Location:</strong> ${brewery.city}, ${brewery.state}</p>
                    <p><strong>Address:</strong> ${brewery.address}</p>
                    <p><strong>Visited:</strong> ${brewery.visited ? 'Yes' : 'No'}</p>
                    ${brewery.visited && brewery.visitDate ? `<p><strong>Visit Date:</strong> ${formatDate(brewery.visitDate)}</p>` : ''}
                    ${brewery.avgRating > 0 ? `<p><strong>Rating:</strong> ${brewery.avgRating.toFixed(1)} / 5</p>` : ''}
                    ${flagshipPreview}
                    <button class="details-btn px-2 py-1 mt-2 bg-beer-light text-beer-dark rounded hover:bg-opacity-90" onclick="openBreweryDetails(${JSON.stringify(brewery).replace(/"/g, '&quot;')})">View Details</button>
                </div>
            `;
            
            // Simply bind the content to the popup
            marker.bindPopup(popupContent);
            
            return marker;
        }

        // Update brewery marker
        function updateBreweryMarker(brewery, marker) {
            // Update icon based on visited status
            const icon = brewery.visited ? fullBeerIcon : emptyBeerIcon;
            marker.setIcon(icon);
            
            // Create popup content with flagship beer preview
            const flagshipPreview = brewery.flagshipBeer ? 
                `<p><strong>Flagship Beer:</strong> ${brewery.flagshipBeer.split(',')[0].trim()}${brewery.flagshipBeer.includes(',') ? '...' : ''}</p>` : '';
            
            // Update popup content
            const popupContent = `
                <div class="brewery-popup">
                    <h3>${brewery.name}</h3>
                    <p><strong>Rank:</strong> ${brewery.rank}</p>
                    <p><strong>Location:</strong> ${brewery.city}, ${brewery.state}</p>
                    <p><strong>Address:</strong> ${brewery.address}</p>
                    <p><strong>Visited:</strong> ${brewery.visited ? 'Yes' : 'No'}</p>
                    ${brewery.visited && brewery.visitDate ? `<p><strong>Visit Date:</strong> ${formatDate(brewery.visitDate)}</p>` : ''}
                    ${brewery.avgRating > 0 ? `<p><strong>Rating:</strong> ${brewery.avgRating.toFixed(1)} / 5</p>` : ''}
                    ${flagshipPreview}
                    <button class="details-btn px-2 py-1 mt-2 bg-beer-light text-beer-dark rounded hover:bg-opacity-90" onclick="openBreweryDetails(${JSON.stringify(brewery).replace(/"/g, '&quot;')})">View Details</button>
                </div>
            `;
            
            marker.getPopup().setContent(popupContent);
        }

        // Create brewery list item
        function createBreweryListItem(brewery) {
            const listItem = document.createElement('div');
            listItem.className = 'brewery-list-item bg-white dark:bg-gray-700 rounded shadow p-3 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer';
            
            // Calculate rating stars
            const ratingStars = [];
            if (brewery.avgRating > 0) {
                const fullStars = Math.floor(brewery.avgRating);
                const halfStar = brewery.avgRating - fullStars >= 0.5;
                
                for (let i = 0; i < 5; i++) {
                    if (i < fullStars) {
                        ratingStars.push('<svg class="inline-block" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#f8b64c"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>');
                    } else if (i === fullStars && halfStar) {
                        ratingStars.push('<svg class="inline-block" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#f8b64c"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill-opacity="0.5"/><path d="M12 2v15.27l-6.18 3.73 1.64-7.03L2 9.24l7.19-.61L12 2z"/></svg>');
                    } else {
                        ratingStars.push('<svg class="inline-block" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#f8b64c" fill-opacity="0.3"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>');
                    }
                }
            }
            
            listItem.innerHTML = `
                <div class="flex items-start">
                    <div class="mr-3 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="${brewery.visited ? '#3b82f6' : '#888888'}" class="${brewery.visited ? 'beer-mug-full' : 'beer-mug-empty'}">
                            <path d="M4,2H19L17,22H6L4,2M6.2,4L7.8,20H8.8L7.43,6.34C8.5,6 9,5 9,4H6.2M9.9,4L11.4,20H12.5L11,4H9.9M16,4L14.6,20H15.6L17.2,4H16M20,2H22V4H20V2M20,10H22V12H20V10M20,18H22V20H20V18Z" />
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <h3 class="font-bold">${brewery.name}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${brewery.city}, ${brewery.state}</p>
                        <div class="flex items-center mt-1">
                            <span class="text-xs px-2 py-0.5 bg-gray-200 dark:bg-gray-600 rounded mr-2">Rank #${brewery.rank}</span>
                            ${brewery.avgRating > 0 ? 
                                `<span class="flex items-center">${ratingStars.join('')} <span class="ml-1 text-sm">${brewery.avgRating.toFixed(1)}</span></span>` : 
                                '<span class="text-xs text-gray-500 dark:text-gray-400">Not rated</span>'}
                        </div>
                        ${brewery.visited && brewery.visitDate ? 
                            `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Visited: ${formatDate(brewery.visitDate)}</p>` : ''}
                    </div>
                </div>
            `;
            
            listItem.addEventListener('click', function() {
                // Open brewery details
                openBreweryDetails(brewery);
            });
            
            return listItem;
        }

        // Generate Untappd URL from brewery name
        function generateUntappdURL(brewery) {
            // Special cases
            if (brewery.name.includes("Sapwood Cellars")) {
                return "https://untappd.com/Sapwood_Cellars";
            } else if (brewery.name.includes("Black Flag")) {
                return "https://untappd.com/BlackFlagBrewingCompany";
            }
            
            // Generic formatting
            let formattedName = brewery.name
                .replace(/\s+(Brewery|Brewing|Brewpub|Brew\s+Pub|Brewing\s+Company|Brewing\s+Co\.?|Beer\s+Co\.?|Brew\s+Co\.?)$/i, '')
                .trim()
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .replace(/\s+/g, '_');
            
            return `https://untappd.com/${formattedName}`;
        }

        // Make openBreweryDetails available globally for popup click handlers
        window.openBreweryDetails = function(brewery) {
            // If brewery is a string (from onclick attribute), parse it
            if (typeof brewery === 'string') {
                try {
                    brewery = JSON.parse(brewery);
                } catch (e) {
                    console.error("Error parsing brewery data:", e);
                    return;
                }
            }
            
            currentBrewery = brewery;
            
            // Set modal title and info
            document.getElementById('modalTitle').textContent = brewery.name;
            document.getElementById('modalRank').textContent = `Rank: #${brewery.rank}`;
            document.getElementById('modalLocation').textContent = `Location: ${brewery.city}, ${brewery.state}`;
            document.getElementById('modalAddress').textContent = `Address: ${brewery.address}`;
            document.getElementById('modalAddress').onclick = function() {
                window.open(`https://maps.google.com/?q=${encodeURIComponent(brewery.address)}`, '_blank');
            };
            
            // Format and display flagship beer information
            if (brewery.flagshipBeer) {
                const beerHTML = brewery.flagshipBeer
                    .split(',')
                    .map(beer => `<li class="mb-1">• ${beer.trim()}</li>`)
                    .join('');
                document.getElementById('modalFlagshipBeer').innerHTML = `<ul class="list-none pl-1">${beerHTML}</ul>`;
            } else {
                document.getElementById('modalFlagshipBeer').textContent = 'Information not available';
            }
            
            // Set visited checkbox and date
            document.getElementById('visitedCheckbox').checked = brewery.visited;
            document.getElementById('visitDateContainer').style.display = brewery.visited ? 'block' : 'none';
            document.getElementById('visitDate').value = brewery.visitDate || '';
            
            // Set ratings
            createRatingMugs('kcRating', 'KC', brewery);
            createRatingMugs('jeffRating', 'Jeff', brewery);
            createRatingMugs('daveRating', 'Dave', brewery);
            
            // Update average rating display
            const avgElement = document.getElementById('avgRating');
            if (brewery.avgRating > 0) {
                avgElement.textContent = brewery.avgRating.toFixed(1) + ' / 5.0';
            } else {
                avgElement.textContent = 'Not rated';
            }
            
            // Set notes and Untappd URL
            document.getElementById('breweryNotes').value = brewery.notes || '';
            document.getElementById('untappdURL').value = brewery.untappdURL || '';
            
            // Set Untappd link
            const untappdURL = brewery.untappdURL || generateUntappdURL(brewery);
            document.getElementById('untappdLink').href = untappdURL;
            
            // Show modal
            document.getElementById('detailsModal').classList.remove('hidden');
        };

        // Close brewery details modal
        function closeBreweryDetails() {
            document.getElementById('detailsModal').classList.add('hidden');
            currentBrewery = null;
        }

        // Save brewery details
        function saveBreweryDetails() {
            if (!currentBrewery) return;
            
            // Get values from form
            const visited = document.getElementById('visitedCheckbox').checked;
            const visitDate = visited ? document.getElementById('visitDate').value : null;
            const notes = document.getElementById('breweryNotes').value;
            const untappdURL = document.getElementById('untappdURL').value.trim();
            
            // Update brewery object
            currentBrewery.visited = visited;
            currentBrewery.visitDate = visitDate;
            currentBrewery.notes = notes;
            currentBrewery.untappdURL = untappdURL;
            
            // Update brewery in the breweries array
            const index = breweries.findIndex(b => b.name === currentBrewery.name && b.city === currentBrewery.city);
            if (index !== -1) {
                breweries[index] = currentBrewery;
                
                // Update marker
                updateBreweryMarker(currentBrewery, markers[index].marker);
                
                // Update list item
                const listItems = document.querySelectorAll('.brewery-list-item');
                if (index < listItems.length) {
                    const listItem = listItems[index];
                    const newListItem = createBreweryListItem(currentBrewery);
                    listItem.replaceWith(newListItem);
                }
                
                // Save to localStorage
                saveToStorage();
                
                // Update stats
                updateStatsUI(calculateStats(breweries));
                
                // Apply filters
                filterBreweries();
            }
            
            // Close modal
            closeBreweryDetails();
            
            // Show success toast
            showToast("Brewery saved successfully! Don't forget to Save to Dropbox.", "success");
        }

        // Filter breweries based on search, state, visited status and rating
        function filterBreweries() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const stateFilter = document.getElementById('stateFilter').value;
            const visitedFilter = document.getElementById('visitedFilter').value;
            const ratingFilter = parseInt(document.getElementById('ratingFilter').value);
            
            breweries.forEach((brewery, index) => {
                if (index >= markers.length) return; // Skip if marker doesn't exist
                
                const marker = markers[index].marker;
                const listItems = document.querySelectorAll('.brewery-list-item');
                const listItem = index < listItems.length ? listItems[index] : null;
                
                // Check if brewery matches all filter criteria
                const matchesSearch = brewery.name.toLowerCase().includes(searchText) || 
                                    brewery.city.toLowerCase().includes(searchText);
                const matchesState = stateFilter === 'all' || brewery.state === stateFilter;
                const matchesVisited = visitedFilter === 'all' || 
                                    (visitedFilter === 'visited' && brewery.visited) || 
                                    (visitedFilter === 'notVisited' && !brewery.visited);
                const matchesRating = isNaN(ratingFilter) || 
                                    (ratingFilter === 0 && brewery.avgRating === 0) ||
                                    (brewery.avgRating >= ratingFilter);
                
                const isVisible = matchesSearch && matchesState && matchesVisited && matchesRating;
                
                // Show or hide marker
                if (isVisible) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
                
                // Show or hide list item
                if (listItem) {
                    listItem.style.display = isVisible ? 'block' : 'none';
                }
            });
        }

        // Initialize the map
        const map = L.map('map').setView([39.5, -77], 7);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <div class="mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="#888888" class="beer-mug-empty">
                        <path d="M4,2H19L17,22H6L4,2M6.2,4L7.8,20H8.8L7.43,6.34C8.5,6 9,5 9,4H6.2M9.9,4L11.4,20H12.5L11,4H9.9M16,4L14.6,20H15.6L17.2,4H16M20,2H22V4H20V2M20,10H22V12H20V10M20,18H22V20H20V18Z" />
                    </svg> Not Visited
                </div>
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="#3b82f6" class="beer-mug-full">
                        <path d="M4,2H19L17,22H6L4,2M6.2,4L7.8,20H8.8L7.43,6.34C8.5,6 9,5 9,4H6.2M9.9,4L11.4,20H12.5L11,4H9.9M16,4L14.6,20H15.6L17.2,4H16M20,2H22V4H20V2M20,10H22V12H20V10M20,18H22V20H20V18Z" />
                    </svg> Visited
                </div>
            `;
            return div;
        };
        legend.addTo(map);

        // Variables to store app state
        let breweries = initializeBreweryData();
        let currentBrewery = null;
        const markers = [];

        // Initialize breweries on the map and in the list
        function initializeBreweries() {
            const breweryList = document.getElementById('breweryList');
            breweryList.innerHTML = '';
            
            // Reset markers array first
            markers.forEach(m => map.removeLayer(m.marker));
            markers.length = 0;
            
            breweries.forEach(brewery => {
                // Create marker
                const marker = createBreweryMarker(brewery);
                marker.addTo(map);
                markers.push({ marker, brewery });
                
                // Create list item
                const listItem = createBreweryListItem(brewery);
                breweryList.appendChild(listItem);
            });
            
            // Update stats
            updateStatsUI(calculateStats(breweries));
        }

        // Event listeners
        document.getElementById('visitedCheckbox').addEventListener('change', function() {
            document.getElementById('visitDateContainer').style.display = this.checked ? 'block' : 'none';
            if (this.checked && !document.getElementById('visitDate').value) {
                document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            }
        });

        document.getElementById('closeModal').addEventListener('click', closeBreweryDetails);
        document.getElementById('saveBrewery').addEventListener('click', saveBreweryDetails);
        
        document.getElementById('statsButton').addEventListener('click', function() {
            document.getElementById('statsModal').classList.remove('hidden');
            updateStatsUI(calculateStats(breweries));
        });
        
        document.getElementById('closeStatsModal').addEventListener('click', function() {
            document.getElementById('statsModal').classList.add('hidden');
        });
        
        // Dropbox dropdown
        document.getElementById('dropboxButton').addEventListener('click', function() {
            document.getElementById('dropboxDropdown').classList.toggle('hidden');
        });
        
        // Hide dropdown when clicking elsewhere
        document.addEventListener('click', function(event) {
            if (!event.target.closest('#dropboxButton') && !event.target.closest('#dropboxDropdown')) {
                document.getElementById('dropboxDropdown').classList.add('hidden');
            }
        });
        
        // Auto-load toggle
        document.getElementById('autoLoadDropbox').addEventListener('change', function() {
            dropboxSettings.autoLoadEnabled = this.checked;
            saveDropboxSettings();
            
            if (this.checked) {
                document.getElementById('autosyncBadge').classList.remove('hidden');
            } else {
                document.getElementById('autosyncBadge').classList.add('hidden');
            }
        });
        
        // Save to Dropbox
        document.getElementById('saveToDropbox').addEventListener('click', function() {
            saveToDropbox();
            document.getElementById('dropboxDropdown').classList.add('hidden');
        });
        
        // Load from Dropbox
        document.getElementById('loadFromDropbox').addEventListener('click', function() {
            showFileChooser();
            document.getElementById('dropboxDropdown').classList.add('hidden');
        });
        
        // Export data
        document.getElementById('exportData').addEventListener('click', function() {
            exportBreweryData(breweries);
            document.getElementById('dropboxDropdown').classList.add('hidden');
        });
        
        // Import data
        document.getElementById('importData').addEventListener('click', function() {
            document.getElementById('fileInput').click();
            document.getElementById('dropboxDropdown').classList.add('hidden');
        });
        
        // File chooser actions
        document.getElementById('cancelChooserBtn').addEventListener('click', function() {
            document.getElementById('fileChooserModal').classList.add('hidden');
        });
        
        document.getElementById('chooseFileBtn').addEventListener('click', function() {
            // Get path from input or use default
            const path = document.getElementById('customFilePath').value.trim() || dropboxSettings.lastUsedFilePath;
            
            // Save path if remember checkbox is checked
            if (document.getElementById('rememberFilePath').checked) {
                dropboxSettings.lastUsedFilePath = path;
                saveDropboxSettings();
            }
            
            // Show instructions to load file
            document.getElementById('fileChooserModal').classList.add('hidden');
            
            // Set purpose to 'dropbox' for the file input
            document.getElementById('fileInput').dataset.purpose = 'dropbox';
            document.getElementById('fileInput').click();
            
            showToast(`Please select the file from your dropbox at: ${path}`, 'info');
        });
        
        // Dropbox notification actions
        document.getElementById('loadUpdateBtn').addEventListener('click', function() {
            // Show file chooser
            showFileChooser();
            hideDropboxNotification();
        });
        
        document.getElementById('dismissUpdateBtn').addEventListener('click', function() {
            hideDropboxNotification();
        });
        
        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', importBreweryData);
        
        // Test Untappd URL
        document.getElementById('testUntappdLink').addEventListener('click', function() {
            const url = document.getElementById('untappdURL').value.trim();
            if (url) {
                window.open(url, '_blank');
            } else {
                // Generate URL based on brewery name
                if (currentBrewery) {
                    const generatedUrl = generateUntappdURL(currentBrewery);
                    window.open(generatedUrl, '_blank');
                }
            }
        });
        
        // Fix common errors in Untappd URLs
        document.getElementById('fixCommonUntappdErrors').addEventListener('click', function() {
            let url = document.getElementById('untappdURL').value.trim();
            
            if (!url && currentBrewery) {
                // Generate URL based on brewery name
                url = generateUntappdURL(currentBrewery);
            } else if (url) {
                // Fix common issues in existing URLs
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }
                
                if (url.includes('untappd.com/search')) {
                    // Convert search URL to direct URL
                    try {
                        const searchTerms = new URL(url).searchParams.get('q');
                        if (searchTerms) {
                            const formattedTerms = searchTerms.replace(/\s+/g, '_');
                            url = `https://untappd.com/${formattedTerms}`;
                        }
                    } catch (e) {
                        console.error("Error parsing URL:", e);
                    }
                }
                
                // Fix common typos
                url = url.replace('untaped.com', 'untappd.com')
                         .replace('untapd.com', 'untappd.com');
            }
            
            document.getElementById('untappdURL').value = url;
            document.getElementById('untappdLink').href = url;
            
            showToast("URL updated. Test it by clicking 'Test URL'", "info");
        });
        
        // Filter listeners
        document.getElementById('searchInput').addEventListener('input', filterBreweries);
        document.getElementById('stateFilter').addEventListener('change', filterBreweries);
        document.getElementById('visitedFilter').addEventListener('change', filterBreweries);
        document.getElementById('ratingFilter').addEventListener('change', filterBreweries);

        // Add New Brewery Feature
        document.getElementById('addBreweryButton').addEventListener('click', function() {
            document.getElementById('addBreweryModal').classList.remove('hidden');
            // Set default date to today for visit date
            document.getElementById('newBreweryVisitDate').value = new Date().toISOString().split('T')[0];
        });
        
        document.getElementById('closeAddBreweryModal').addEventListener('click', function() {
            document.getElementById('addBreweryModal').classList.add('hidden');
        });
        
        // Show/hide "Other" state field based on state selection
        document.getElementById('newBreweryState').addEventListener('change', function() {
            if (this.value === 'other') {
                document.getElementById('otherStateContainer').classList.remove('hidden');
            } else {
                document.getElementById('otherStateContainer').classList.add('hidden');
            }
        });
        
        // Show/hide visit date based on visited checkbox
        document.getElementById('newBreweryVisited').addEventListener('change', function() {
            document.getElementById('newBreweryVisitDateContainer').style.display = this.checked ? 'block' : 'none';
        });
        
        // Get coordinates from address using geocoding
        document.getElementById('geolocateAddress').addEventListener('click', async function() {
            const address = document.getElementById('newBreweryAddress').value;
            if (!address) {
                showToast('Please enter an address first.', 'error');
                return;
            }
            
            try {
                // Show loading state
                this.disabled = true;
                this.innerHTML = '<div class="spinner inline-block mr-2" style="width: 16px; height: 16px;"></div> Getting coordinates...';
                
                // Nominatim geocoding API (OpenStreetMap)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    document.getElementById('newBreweryLat').value = lat;
                    document.getElementById('newBreweryLng').value = lng;
                    
                    // Center map on the location
                    map.setView([lat, lng], 15);
                    
                    // Add a temporary marker
                    const tempMarker = L.marker([lat, lng]).addTo(map);
                    tempMarker.bindPopup(`<b>New Location</b><br>${address}`).openPopup();
                    
                    // Remove marker after 5 seconds
                    setTimeout(() => map.removeLayer(tempMarker), 5000);
                    
                    showToast('Coordinates obtained successfully!', 'success');
                } else {
                    showToast('Could not find coordinates for the provided address. Please enter coordinates manually.', 'error');
                }
            } catch (error) {
                console.error('Error geocoding address:', error);
                showToast('Error getting coordinates. Please enter them manually.', 'error');
            } finally {
                // Reset button
                this.disabled = false;
                this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> Get Coordinates from Address';
            }
        });
        
        // Add new brewery
        document.getElementById('addNewBrewery').addEventListener('click', function() {
            // Validate form
            const name = document.getElementById('newBreweryName').value.trim();
            const city = document.getElementById('newBreweryCity').value.trim();
            let state = document.getElementById('newBreweryState').value;
            const address = document.getElementById('newBreweryAddress').value.trim();
            const lat = parseFloat(document.getElementById('newBreweryLat').value);
            const lng = parseFloat(document.getElementById('newBreweryLng').value);
            const rank = parseInt(document.getElementById('newBreweryRank').value) || breweries.length + 1;
            const visited = document.getElementById('newBreweryVisited').checked;
            const visitDate = visited ? document.getElementById('newBreweryVisitDate').value : null;
            const notes = document.getElementById('newBreweryNotes').value.trim();
            const flagshipBeer = document.getElementById('newBreweryFlagshipBeer').value.trim();
            
            // Check if state is "other" and get custom state
            if (state === 'other') {
                state = document.getElementById('otherState').value.trim();
                if (!state) {
                    showToast('Please enter a state name.', 'error');
                    return;
                }
            }
            
            // Validate required fields
            if (!name) {
                showToast('Please enter a brewery name.', 'error');
                return;
            }
            
            if (!city) {
                showToast('Please enter a city.', 'error');
                return;
            }
            
            if (!state) {
                showToast('Please select a state.', 'error');
                return;
            }
            
            if (!address) {
                showToast('Please enter an address.', 'error');
                return;
            }
            
            if (isNaN(lat) || isNaN(lng)) {
                showToast('Please enter valid coordinates. You can use the "Get Coordinates from Address" button to automatically fill these in.', 'error');
                return;
            }
            
            // Create new brewery object
            const newBrewery = {
                name,
                rank,
                city,
                state,
                address,
                lat,
                lng,
                visited,
                visitDate,
                notes,
                flagshipBeer,
                distance: 0, // Default distance
                ratings: { KC: 0, Jeff: 0, Dave: 0 },
                avgRating: 0,
                untappdURL: '',
                isCustom: true // Mark as custom brewery
            };
            
            // Add to breweries array
            breweries.push(newBrewery);
            
            // Create marker
            const marker = createBreweryMarker(newBrewery);
            marker.addTo(map);
            markers.push({ marker, brewery: newBrewery });
            
            // Create list item
            const listItem = createBreweryListItem(newBrewery);
            document.getElementById('breweryList').appendChild(listItem);
            
            // Save to localStorage
            saveToStorage();
            
            // Update stats
            updateStatsUI(calculateStats(breweries));
            
            // Reset form
            document.getElementById('newBreweryName').value = '';
            document.getElementById('newBreweryRank').value = '';
            document.getElementById('newBreweryCity').value = '';
            document.getElementById('newBreweryState').value = '';
            document.getElementById('newBreweryAddress').value = '';
            document.getElementById('newBreweryLat').value = '';
            document.getElementById('newBreweryLng').value = '';
            document.getElementById('newBreweryVisited').checked = false;
            document.getElementById('newBreweryVisitDateContainer').style.display = 'none';
            document.getElementById('newBreweryNotes').value = '';
            document.getElementById('newBreweryFlagshipBeer').value = '';
            document.getElementById('otherStateContainer').classList.add('hidden');
            
            // Close modal
            document.getElementById('addBreweryModal').classList.add('hidden');
            
            showToast(`${name} has been added to your brewery list! Don't forget to save to Dropbox.`, 'success');
            
            // Center map on new brewery
            map.setView([lat, lng], 12);
        });
        
        // Auto-load from Dropbox on startup if enabled
        function checkForDropboxUpdatesOnStartup() {
            if (dropboxSettings.autoLoadEnabled) {
                showToast("Auto-loading from Dropbox is enabled. You'll be prompted to select the file...", "info");
                
                // Show the file chooser after a brief delay
                setTimeout(() => {
                    showFileChooser();
                }, 2000);
            }
        }
        
        // Load Dropbox settings on startup
        loadDropboxSettings();
        
        // Initialize the app
        initializeBreweries();
        
        // Set up auto-loading
        setupAutoLoad();
        
        // Check for updates if auto-load is enabled
        checkForDropboxUpdatesOnStartup();
    </script>
</body>
</html>